<!DOCTYPE html>
<html lang="en" ng-app="orbitable">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="m_kinsey">
    <link rel="icon" href="favicon.ico">

    <title>Orbitable</title>

    <!-- Bootstrap core CSS -->
    <link href="/css/bootstrap.min.css" rel="stylesheet">

    <!--jQuery-->
    <script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/2.0.0/jquery.min.js"></script>
    
    <!--Angular-->
    <script src="//ajax.googleapis.com/ajax/libs/angularjs/1.2.23/angular.min.js"></script>
    <script src="//ajax.googleapis.com/ajax/libs/angularjs/1.2.23/angular-route.min.js">

    <!--D3-->
    <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
	
    <!--JS-->
    <script src="/js/d3.min.js"></script>
    <script src="/js/orbit.min.js"></script>

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>

<body>
<div class="container" ng-controller="BodyCtrl">

    <div class="page-header">
        <h1>Orbitable<span style="font-weight: 200; color: #888;">.me</span></h1>
        <p class="lead"><ng-pluralize count="users" when="{'one': '1 user', 'other': '{} users'}"></ng-pluralize> online</p>
        <div ng-hide="!showreconnect" class="alert alert-danger">Blast! You've been disconnected somehow. <a href="#" ng-click="connect()" class="alert-link">Click here</a> to reconnect.</div>
    </div>

    <div class="row">
        <div class="col-md-8">
          <d3-bodies running="running" height-trim="260" min-zoom="0.1" max-zoom="10" size-factor="0.5" bodies="bodies" viewport="viewport" current-body="currentBody"></d3-bodies>
            <div class="row panel panel-default" ng-hide="currentBody==null">
                <div class="col-md-6 panel-body" style="text-align: center;">
                    <div class="col-md-2">
                        <h5>Pos</h5>
                    </div>
                    <div class="col-md-5">
                        <div class="input-group">
                            <div class="input-group-addon">x</div>
                            <input ng-model="currentBody.x" ng-disabled="running" type="number" placeholder="X position of Planet 2" style="width: 75px;" class="form-control"/>
                        </div>
                    </div>
                    <div class="col-md-5">
                        <div class="input-group">
                            <div class="input-group-addon">y</div>
                            <input ng-model="currentBody.y" ng-disabled="running" type="number" placeholder="Y position of Planet 2" style="width: 75px;" class="form-control" />
                        </div>
                    </div>
                </div>
                <div class="col-md-6 panel-body" style="text-align: center; border-left: 1px solid #ddd;">
                    <div class="input-group">
                        <div class="input-group-addon">Mass:</div>
                        <input ng-model="currentBody.m" ng-disabled="running" type="number" min="0" placeholder="Mass of Planet 1" class="form-control" />
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <button name="start" ng-click="start()" ng-disabled="running || !connected">START</button>
            <button name="stop" ng-click="stop()" ng-disabled="!running || !connected">STOP</button>
            <button name="reset" ng-click="reset()" ng-disabled="!connected">RESET</button>
            <button name="center" ng-click="viewport.zoom = 1; viewport.translation = [0,0]">CENTER</button>
            <br>
            <input ng-model="viewport.zoom" type="range" max="10" min="0.1" step="0.1" />
            <input ng-model="viewport.translation[0]" type="number" class="form-control" />
            <input ng-model="viewport.translation[1]" type="number" class="form-control" />
            <br>
            <textarea id="console" style="width: 100%;height: 200px; color: white; background-color: black;" readonly="readonly"></textarea>
        </div>
    </div>
</div> <!-- /container -->

<script type="text/javascript">
watchProblem = false;
watchBodyProblem = true;
angularsocket = null;
orbitable.controller('BodyCtrl', ['$scope',
function($scope) {
    $scope.viewport = {};
    $scope.viewport.zoom = 1;
    $scope.running = false;
    $scope.viewport.translation = [0,0];
    $scope.connected = false;
    $scope.showreconnect = false;
    $scope.currentBody = null;

    $scope.users = 1;

    var send = function(thing) {
        angularsocket.send(encodeURIComponent(JSON.stringify(thing)));
    };

    $scope.stop = function() {
        send({ command: 'stop' });
    };

    $scope.start = function() {
        send({ command: 'start' });
    };

    $scope.reset = function() {
        send({ command: 'reset' });
    };

    $scope.connect = function() {
        angularsocket = new WebSocket('@{config['websocket-url']}');
        angularsocket.onopen = function() { 
            console.log("connected");
            $scope.$apply(function() {
                    $scope.connected = true;
                    $scope.showreconnect = false;
                });
        };
        angularsocket.onclose = function() {
            console.log("disconnected");
            $scope.$apply(function() {
                    $scope.connected = false;
                    $scope.showreconnect = true;
                    $scope.users = 0;
                });
        };
        angularsocket.onmessage = function(e) {
            var command = JSON.parse(decodeURIComponent(e.data)).command;
            if (command === 'initialize') {
                $scope.$apply(function() {
                    var bodies = JSON.parse(decodeURIComponent(e.data)).bodies;
                    bodyData = [];
                    for (var i = 0; i < bodies.length; i++) {
                        var body = bodies[i];
                        var bodyStruct = {};
                        bodyStruct['id'] = body[0];
                        bodyStruct['x'] = body[1];
                        bodyStruct['y'] = body[2];
                        bodyStruct['m'] = body[3];
                        bodyStruct['c'] = body[4];
                        bodyData.push(bodyStruct);
                    }
                    $scope.bodies = bodyData;
                    if($scope.currentBody != null) {
                        $scope.currentBody = $scope.bodies[$scope.currentBody.id];
                    }
                    $scope.running = JSON.parse(decodeURIComponent(e.data)).running;
                });
            } else if (command === 'update') {
                $scope.$apply(function() {
                        var positions = JSON.parse(decodeURIComponent(e.data)).positions;
                        for (var i = 0; i < positions.length; i++) {
                            bodyData[i].x = positions[i][1];
                            bodyData[i].y = positions[i][2];
                        }
                    });
            } else if (command === 'edit') {
                watchBodyProblem = true;
                $scope.$apply(function() {
                        var body = JSON.parse(decodeURIComponent(e.data)).body;
                        bodyData[body.id].x = body.x;
                        bodyData[body.id].y = body.y;
                        bodyData[body.id].m = body.m;
                    });
            } else if (command === 'viewport') {
                watchProblem = true;
                $scope.$apply(function() {
                        $scope.viewport = {zoom: JSON.parse(decodeURIComponent(e.data)).zoom, translation: JSON.parse(decodeURIComponent(e.data)).translation};
                    });
            } else if (command === 'users') {
                $scope.$apply(function() {
                        $scope.users = JSON.parse(decodeURIComponent(e.data)).users;
                    });
            } else if (command === 'start') {
                $scope.$apply(function() {
                        $scope.running = true;
                    });
            } else if (command === 'stop') {
                $scope.$apply(function() {
                        $scope.running = false;
                    });
            }
        };
    };

    $scope.connect();

    $scope.$watch("viewport", function(newView) {
           if(angularsocket.readyState != 0 && !watchProblem) {
               angularsocket.send(encodeURIComponent(JSON.stringify({command: "viewport", translation: newView.translation, zoom: newView.zoom})));
           }
           watchProblem = false;
        }, true);

    $scope.$watch("bodies", function(newBodies) {
           if(!$scope.running && !watchBodyProblem && $scope.currentBody != null) {
                angularsocket.send(encodeURIComponent(JSON.stringify({command: "edit", body: $scope.currentBody})));
           }
           watchBodyProblem = false;
        }, true);
}
]);
</script>
</body>
</html>

