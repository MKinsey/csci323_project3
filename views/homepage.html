<!DOCTYPE html>
<html lang="en" ng-app="orbitable">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="m_kinsey">
    <link rel="icon" href="favicon.ico">

    <title>Orbitable</title>

    <!-- Bootstrap core CSS -->
    <link href="/css/bootstrap.min.css" rel="stylesheet">

    <!--jQuery-->
    <script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/2.0.0/jquery.min.js"></script>

    <!--Angular-->
    <script src="//ajax.googleapis.com/ajax/libs/angularjs/1.2.23/angular.min.js"></script>
    <script src="//ajax.googleapis.com/ajax/libs/angularjs/1.2.23/angular-route.min.js">

        <!--D3-->
        <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>

    <!--JS-->
    <script src="/js/d3.min.js"></script>
    <script src="/js/orbit.min.js"></script>

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>

<body>
<div class="container" ng-controller="BodyCtrl">

    <div class="page-header">
        <h1>Orbitable<span style="font-weight: 200; color: #888;">.me</span></h1>
        <p class="lead"><ng-pluralize count="users" when="{'one': '1 user', 'other': '{} users'}"></ng-pluralize> online</p>
        <span id="userinfo" class="lead" >You: <b>{{name}}</b> with <b><ng-pluralize count="type" when="{'0': 'view', '1': 'edit', '2': 'admin'}"></ng-pluralize></b> access</span>
        <div ng-hide="!showreconnect" class="alert alert-danger">Blast! You've been disconnected somehow. <a href="#" ng-click="connect()" class="alert-link">Click here</a> to reconnect.</div>
    </div>

    <div class="row">
        <div class="col-md-8">
            <d3-bodies running="running" height-trim="260" min-zoom="0.1" max-zoom="10" size-factor="0.5" bodies="bodies" viewport="viewport" current-body="currentBody"></d3-bodies>
            <div class="row panel panel-default" ng-hide="currentBody==null">
                <div class="col-md-6 panel-body" style="text-align: center;">
                    <div class="col-md-2">
                        <h5>Pos</h5>
                    </div>
                    <div class="col-md-5">
                        <div class="input-group">
                            <div class="input-group-addon">x</div>
                            <input ng-model="currentBody.x" ng-disabled="running" type="number" placeholder="X position of Planet 2" style="width: 75px;" class="form-control"/>
                        </div>
                    </div>
                    <div class="col-md-5">
                        <div class="input-group">
                            <div class="input-group-addon">y</div>
                            <input ng-model="currentBody.y" ng-disabled="running" type="number" placeholder="Y position of Planet 2" style="width: 75px;" class="form-control" />
                        </div>
                    </div>
                </div>
                <div class="col-md-6 panel-body" style="text-align: center; border-left: 1px solid #ddd;">
                    <div class="input-group">
                        <div class="input-group-addon">Mass:</div>
                        <input ng-model="currentBody.m" ng-disabled="running" type="number" min="0" placeholder="Mass of Planet 1" class="form-control" />
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">

            <button name="start" ng-click="start()" ng-disabled="running || !connected" style="width: 33%;">START</button>
            <button name="stop" ng-click="stop()" ng-disabled="!running || !connected" style="width: 33%;">STOP</button>
            <button name="reset" ng-click="reset()" ng-disabled="!connected" style="width: 33%;">RESET</button>
            <br>
            <input ng-model="viewport.zoom" readonly="readonly" type="range" max="10" min="0.1" step="0.1" />
            <input ng-model="viewport.translation[0]" type="number" class="form-control" />
            <input ng-model="viewport.translation[1]" type="number" class="form-control" />
            <button name="center" style="width: 100%;" ng-click="viewport.zoom = 1; viewport.translation = [0,0]">CENTER</button>
            <br>
            <textarea id="console" style="font-size: 12px; width: 100%;height: 200px; color: white; background-color: black; resize: none" readonly="readonly"></textarea>
            <br>
            <input name="input" type="text" style="width: 100%;height: 25px; color: white; background-color: black;" >
            <br>
            <button name="send"   style="width: 33%;"ng-click="send()" >SEND</button>
            <button name="rename" style="width: 33%;"ng-click="rename()" >RENAME</button>
            <button name="admin"  style="width: 33%;"disabled="disabled" ng-click="admin()" >PLAY GOD</button>
            <span id="pingLabel"  style="font-size: 10px;" class="lead" >Ping: {{ping}} ms</span>
            <br>
            <span id="fpsLabel"   style="font-size: 10px;" class="lead" >FPS: {{fps}}</span>
        </div>
    </div>
</div> <!-- /container -->

<script type="text/javascript">
watchProblem = true;
watchBodyProblem = true;
angularsocket = null;
minNameLength = 4;
consoleArea = $('#console');
consoleText = "";
inputArea = $('#input');
userinfo = $('#userinfo');

orbitable.controller('BodyCtrl', ['$scope',
function($scope) {
    $scope.viewport = {};
    $scope.viewport.zoom = 1;
    $scope.running = false;
    $scope.viewport.translation = [0,0];
    $scope.connected = false;
    $scope.showreconnect = false;
    $scope.currentBody = null;
    $scope.name = null;
    $scope.type = null;
    $scope.index = null;
    $scope.ping = null;
    $scope.fps = null;

    $scope.users = 1;
    
    function angularSend(message) {
        angularsocket.send(encodeURIComponent(JSON.stringify(message)));
    }
    
    function log(text) {
        consoleText = text + "\n" + consoleText;
        consoleArea.val(consoleText);
        if (consoleText.length > 500) {consoleText = consoleText.substring(0,250);}
    }
    
    $scope.connect = function() {
        angularsocket = new WebSocket('@{config['websocket-url']}');
        angularsocket.onopen = function() { 
            console.log("connected");
            $scope.$apply(function() {
                    $scope.connected = true;
                    $scope.showreconnect = false;
                });
        };
        angularsocket.onclose = function() {
            console.log("disconnected");
            $scope.$apply(function() {
                    $scope.connected = false;
                    $scope.showreconnect = true;
                    $scope.users = 0;
                });
        };
        angularsocket.onmessage = function(e) {
            var message = JSON.parse(decodeURIComponent(e.data));
            var command = message.command;
            if (command === 'initialize') {
                $scope.$apply(function() {
                    var bodies = message.bodies;
                    bodyData = [];
                    for (var i = 0; i < bodies.length; i++) {
                        var body = bodies[i];
                        var bodyStruct = {};
                        bodyStruct['id'] = body[0];
                        bodyStruct['x'] = body[1];
                        bodyStruct['y'] = body[2];
                        bodyStruct['m'] = body[3];
                        bodyStruct['c'] = body[4];
                        bodyData.push(bodyStruct);
                    }
                    $scope.bodies = bodyData;
                    if($scope.currentBody != null) {
                        $scope.currentBody = $scope.bodies[$scope.currentBody.id];
                    }
                    $scope.running = message.running;
                });
            } else if (command === 'update') {
                $scope.$apply(function() {
                        var positions = message.positions;
                        for (var i = 0; i < positions.length; i++) {
                            bodyData[i].x = positions[i][1];
                            bodyData[i].y = positions[i][2];
                        }
                        $scope.ping = Math.round(message.ping*100)/100;
                        $scope.fps = Math.round(10000/$scope.ping)/10;
                    });
            } else if (command === 'edit') {
                watchBodyProblem = true;
                $scope.$apply(function() {
                        var body = message.body;
                        bodyData[body.id].x = body.x;
                        bodyData[body.id].y = body.y;
                        bodyData[body.id].m = body.m;
                    });
            } else if (command === 'viewport') {
                watchProblem = true;
                $scope.$apply(function() {
                        $scope.viewport = {zoom: message.zoom, translation: message.translation};
                    });
            } else if (command === 'users') {
                $scope.$apply(function() {
                        $scope.users = message.users;
                    });
            } else if (command === 'start') {
                $scope.$apply(function() {
                        $scope.running = true;
                    });
            } else if (command === 'stop') {
                $scope.$apply(function() {
                        $scope.running = false;
                    });
            } else if (command === 'updateuser') {
                $scope.$apply(function() {
                    if (message.name != null) {
                        $scope.name = message.name;
                    }
                    if (message.type != null) {
                        $scope.type = message.type;
                    }
                    if (message.index != null) {
                        $scope.index = message.index;
                    }
                });
            } else if (command === 'message') {
                $scope.$apply(function() {
                    log("Orbot: " + message.text);
                });
            } else if (command === 'chat') {
                $scope.$apply(function() {
                    log(message.sender + ": " + message.text);
                });
            }
        };
    };
    
    $scope.stop = function() {
        angularSend({ command: 'stop' });
    };

    $scope.start = function() {
        angularSend({ command: 'start' });
    };

    $scope.reset = function() {
        angularSend({ command: 'reset' });
    };
    
    $scope.send = function() {
        var text = $('input[name="input"]').val().toString();
        //log(">SEND " + text);
        angularSend({command: 'send', text: text});
        $('input[name="input"]').val("");
    };
    
    $scope.rename = function() {
        var text =  $('input[name="input"]').val().toString();
        if (text.length >= minNameLength) {
            //log(">RENAME " + text);
            angularSend({command: 'rename', index: $scope.index, name: text});
            if ($scope.type == 0) {
                angularSend({command: 'requesttype', index: $scope.index, type: 1, key: null});
            }
            $('input[name="input"]').val("");
        }
        else {
            log("Name must be " + minNameLength + " characters or longer!");
        }
        
    };
    
    $scope.admin = function() {
        if ($scope.type == 1) {
            var key = window.prompt("Admin Key:","");
            angularSend({command: 'requesttype', index: $scope.index, type: 2, key: key});
        }
    };
    
    $scope.$watch("viewport", function(newView) {
           if(angularsocket.readyState != 0 && !watchProblem) {
               angularSend({command: "viewport", translation: newView.translation, zoom: newView.zoom});
           }
           //watchProblem = false;
        }, true);
        
    $scope.$watch("type", function() {
        if ($scope.type == 0) {
            $('button[name="admin"],button[name="start"],button[name="stop"],button[name="reset"]').attr('disabled', true);
            log("You now have view access.");
        }
        if ($scope.type == 1) {
            // TODO: active ability to add/modify bodies here
            $('button[name="admin"]').attr('disabled', false);
            $('button[name="start"],button[name="stop"],button[name="reset"]').attr('disabled', true);
            log("You now have edit access.");
        }
        if ($scope.type == 2) {
            $('button[name="admin"],button[name="start"],button[name="stop"],button[name="reset"]').attr('disabled', false);
            log("With great power comes great responsibility...");
        }
    }, true);

    $scope.$watch("bodies", function(newBodies) {
           if(!$scope.running && !watchBodyProblem && $scope.currentBody != null) {
                angularsocket.send(encodeURIComponent(JSON.stringify({command: "edit", body: $scope.currentBody})));
           }
           watchBodyProblem = false;
        }, true);
        
        // begin
        
    $scope.connect();
}
]);
</script>
</body>
</html>

