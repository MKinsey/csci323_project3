var orbitable = angular.module('orbitable', ['d3'])
    .directive('d3Bodies', ['$window', '$timeout', 'd3Service',
        function($window, $timeout, d3Service) {
            return {
                restrict: 'EA',
                scope: {
                    data: '='
                },
                link: function(scope, ele, attrs) {
                    d3Service.d3().then(function(d3) {

                        var renderTimeout;
                        var sizeFactor = parseInt(attrs.sizeFactor) || 1,
                            heightTrim = parseInt(attrs.heightTrim) || 260;

                        var svg = d3.select(ele[0])
                            .append('svg')
                            .style('width', '100%');

                        $window.onresize = function() {
                            scope.$apply();
                        };

                        scope.$watch(function() {
                            return angular.element($window)[0].innerHeight;
                        }, function() {
                            svg.style('height', window.innerHeight - heightTrim);
                            scope.render(scope.data);
                        });

                        scope.$watch('data', function(newData) {
                            scope.updateRender(newData);
                        }, true);

                        scope.updatePositions = function(circles) {
                            circles.attr("cx", function(d) {
                                return d.x
                            });
                            circles.attr("cy", function(d) {
                                return d.y
                            });
                            circles.attr("r", function(d) {
                                return Math.sqrt(d.m * sizeFactor)
                            });
                        };

                        scope.updateRender = function(data) {
                            var circleData = svg.selectAll("circle").data(data);
                            scope.updatePositions(circleData);
                        };

                        scope.render = function(data) {
                            svg.selectAll('*').remove();
                            if (!data) return;
                            if (renderTimeout) clearTimeout(renderTimeout);

                            renderTimeout = $timeout(function() {
                                var masses = data.map(function(d) {
                                    return d.m;
                                });
                                var circle = svg.selectAll("circle").data(data);
                                var circleEnter = circle.enter().append("circle");

                                scope.updatePositions(circleEnter);
                            });
                        };
                    });
                }
            }
        }
    ]);

bodyData = [{
    id: 0,
    x: 50,
    y: 20,
    m: 10
}, {
    id: 1,
    x: 100,
    y: 20,
    m: 20
}, {
    id: 2,
    x: 150,
    y: 20,
    m: 30
}];

orbitable.controller('BodyCtrl', ['$scope',
function($scope) {
    angularsocket = new WebSocket('ws://127.0.0.1:8000');
    $scope.data = bodyData;
    angularsocket.onmessage = function(e) {
        var command = JSON.parse(decodeURIComponent(e.data)).command;
        if (command === 'initialize') {
            var bodies = JSON.parse(decodeURIComponent(e.data)).bodies;
            bodyData = [];
            for (var i = 0; i < bodies.length; i++) {
                var body = bodies[i];
                var bodyStruct = {};
                bodyStruct['id'] = body[0];
                bodyStruct['x'] = body[1];
                bodyStruct['y'] = body[2];
                bodyStruct['m'] = body[3];
                bodyData.push(bodyStruct);
            }
            $scope.data = bodyData;
        } else if (command === 'update') {
            $scope.$apply(function() {
                var positions = JSON.parse(decodeURIComponent(e.data)).positions;
                for (var i = 0; i < positions.length; i++) {
                    bodyData[i].x = positions[i][1];
                    bodyData[i].y = positions[i][2];
                }
            });
            //$scope.data = bodyDataList;
        } else {
            //$scope.data = bodyData;
        }
    }
}
]);
