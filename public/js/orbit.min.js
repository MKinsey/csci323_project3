var orbitable = angular.module('orbitable', ['d3'])
    .directive('d3Bodies', ['$window', '$timeout', 'd3Service',
        function($window, $timeout, d3Service) {
            return {
                restrict: 'EA',
                scope: {
                    data: '='
                },
                link: function(scope, ele, attrs) {
                    d3Service.d3().then(function(d3) {

                        var renderTimeout;
                        var sizeFactor = parseInt(attrs.sizeFactor) || 1,
                            heightTrim = parseInt(attrs.heightTrim) || 260;

                        var svg_c = d3.select(ele[0])
                            .append('svg')
                            .style('width', '100%');

                        var svg = svg_c.append("g");

                        svg_c.call(d3.behavior.zoom().scaleExtent([1,8]).on("zoom", function() {
                                        svg.attr("transform", "translate(" + d3.event.translate + ") scale(" + d3.event.scale +")");
                                        console.log(d3.event);
                                    }));

                        var length = 0;

                        $window.onresize = function() {
                            scope.$apply();
                        };

                        scope.$watch(function() {
                            return angular.element($window)[0].innerHeight;
                        }, function() {
                            svg_c.style('height', window.innerHeight - heightTrim);
                            scope.render(scope.data);
                        });

                        scope.$watch('data', function(newData) {
                            if(newData.length != length) {
                                scope.render(newData);
                                length = newData.length;
                            }
                            scope.updateRender(newData);
                        }, true);

                        scope.updatePositions = function(circles) {
                            circles.attr("cx", function(d) {
                                return d.x
                            });
                            circles.attr("cy", function(d) {
                                return d.y
                            });
                            circles.attr("r", function(d) {
                                return Math.sqrt(d.m * sizeFactor)
                            });
                            return circles;
                        };

                        scope.drag = d3.behavior.drag().origin(function(d) { return d }).on("dragstart", function(d) {
                                console.log("Drag started");
                                d3.event.sourceEvent.stopPropagation();
                            }).on("drag", function(d) {
                                console.log("drag", d, d3.event)
                                scope.$apply(function() {
                                        var myCircle = d3.select(this);
                                        d.x = d3.event.x;
                                        d.y = d3.event.y;
                                    });
                            }).on("dragend", function() {
                                console.log("drag ended");
                            });

                        scope.updateRender = function(data) {
                            var circleData = svg.selectAll("circle").data(data);
                            scope.updatePositions(circleData);
                        };

                        scope.render = function(data) {
                            svg.selectAll('*').remove();
                            if (!data) return;
                            if (renderTimeout) clearTimeout(renderTimeout);

                            renderTimeout = $timeout(function() {
                                var masses = data.map(function(d) {
                                    return d.m;
                                });
                                var circle = svg.selectAll("circle").data(data);
                                var circleEnter = circle.enter().append("circle").call(scope.drag);
                                scope.updatePositions(circleEnter);
                            });
                        };
                    });
                }
            }
        }
    ]);

/*bodyData = [{
    id: 0,
    x: 50,
    y: 20,
    m: 10
}, {
    id: 1,
    x: 100,
    y: 20,
    m: 20
}, {
    id: 2,
    x: 150,
    y: 20,
    m: 30
    }];*/

bodyData = [];
